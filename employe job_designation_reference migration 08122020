truncate table records.employee restart identity cascade;


truncate table records.job_designation_reference restart identity cascade;


select setval('hibernate_sequence',1000);
select last_value from hibernate_sequence;



truncate table leaves.leave_allocation restart identity cascade;
truncate table leaves.leave_request restart identity cascade;


psql "dbname=hydra options=--search_path=leaves" -a -f /tmp/fn_leave_allocation_request_egems_to_hydra.sql


truncate table leaves.leave_schedule restart identity cascade;
truncate table leaves.join_leave_schedule_x_leave_policy restart identity cascade;



truncate table timekeeping.timesheet restart identity cascade;



                                                          Table "leaves.leave_allocation"
      Column       |            Type             | Collation | Nullable |             Default              | Storage  | Stats target | Description 
-------------------+-----------------------------+-----------+----------+----------------------------------+----------+--------------+-------------
 id                | bigint                      |           | not null | generated by default as identity | plain    |              | 
 deleted           | character(1)                |           |          |                                  | extended |              | 
 created_by        | character varying(50)       |           |          |                                  | extended |              | 
 created_date      | timestamp without time zone |           |          |                                  | plain    |              | 
 updated_date      | timestamp without time zone |           |          |                                  | plain    |              | 
 updated_by        | character varying(250)      |           |          |                                  | extended |              | 
 version           | bigint                      |           |          |                                  | plain    |              | 
 employee_number   | character varying(255)      |           |          |                                  | extended |              | 
 is_usable         | character(1)                |           |          |                                  | extended |              | 
 leave_count       | numeric(19,2)               |           |          |                                  | main     |              | 
 leave_type        | character varying(255)      |           |          |                                  | extended |              | 
 leave_end_date    | date                        |           |          |                                  | plain    |              | 
 leave_start_date  | date                        |           |          |                                  | plain    |              | 
 linked_leave_type | character varying(255)      |           |          |                                  | extended |              | 
 is_calendar_day   | character(1)                |           |          |                                  | extended |              | 
 is_continuous     | character(1)  


select count(1) from leave_allocation where extract(year from leave_start_date) = 2020 and leave_type = 'EL';
--66

select * from leave_allocation where extract(year from leave_start_date) = 2020 and leave_type = 'EL';

update leave_allocation 
set leave_start_date = '2020-01-01',
leave_end_date = '2020-12-31' 
where extract(year from leave_start_date) = 2020 and leave_type = 'EL';


select * from leave_allocation a right join records.employee b on a.employee_number = b.employee_number
where a.leave_type = 'EL' and extract(year from leave_start_date) = 2020;


select count(1) from records.employee where employee_number not in (select employee_number from leave_allocation where leave_type = 'EL' and extract(year from leave_start_date) = 2020);
--698

INSERT INTO leaves.leave_allocation (id, deleted, created_by, created_date, updated_date, updated_by, version, employee_number, is_usable, leave_count, leave_type, leave_end_date, leave_start_date, linked_leave_type, is_calendar_day, is_continuous)

deleted = 'N'
version = 0
employee_number = 
is_usable = Y
leave_count = 0
leave_type = EL
leave_start_date =  01-01-2020
leave_end_date = 12-31-2020
linked_leave_type = VL
is_calendar_day = N
is_continous = N

INSERT INTO leaves.leave_allocation
select 
NEXTVAL('hibernate_sequence'),
'N' AS deleted, --deleted
NULL AS created_by, --created_by
CAST(NULL AS timestamp with time zone) AS created_date, --created_date
CAST(NULL AS timestamp with time zone) AS updated_date, --updated_date
NULL AS updated_by, --updated_by,
0 AS version, --version,	
employee_number, --employee_number
'Y' AS is_usable, --is_usable
0 AS leave_count, --leave_count
'EL' AS leave_type, --leave_type
'2020-12-31' AS leave_end_date, --leave_end_date
'2020-01-01' AS leave_start_date, --leave_start_date
'VL' AS linked_leave_type, --linked_leave_type
'N' AS is_calendar_day, --is_calendar_day
'N' AS is_continuous --is_continuous
from records.employee where employee_number not in (select employee_number from leave_allocation where leave_type = 'EL' and extract(year from leave_start_date) = 2020);



delete from leave_allocation where employee_number in
(select b.employee_number from leave_allocation a join records.employee b on a.employee_number = b.employee_number
where a.leave_type = 'EL' and extract(year from leave_start_date) = 2020 and b.employment_status <> 'REGULAR')
and leave_type = 'EL' and extract(year from leave_start_date) = 2020;

select count(1) from leave_allocation where employee_number in
(select b.employee_number from leave_allocation a join records.employee b on a.employee_number = b.employee_number
where a.leave_type = 'EL' and extract(year from leave_start_date) = 2020 and b.employment_status <> 'REGULAR')
and leave_type = 'EL' and extract(year from leave_start_date) = 2020;



select count(1) from leave_allocation a join records.employee b on a.employee_number = b.employee_number
where a.leave_type = 'EL' and extract(year from leave_start_date) = 2020 and b.employment_status <> 'REGULAR';

